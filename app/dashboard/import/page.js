'use client'

import { useState, useEffect } from 'react'
import { apiFetch } from '@/lib/auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Upload, CheckCircle, AlertCircle, Loader2, Key, RefreshCw, Link2 } from 'lucide-react'

// ────────── CSV HELPERS ──────────
const STATUS_MAP = {
  'implemented/ completed': 'Completed', 'implemented/completed': 'Completed',
  'completed': 'Completed', 'complete': 'Completed', 'done': 'Completed', 'fixed': 'Completed',
  'work in progress': 'In Progress', 'in progress': 'In Progress', 'wip': 'In Progress',
  'to be approved': 'To Be Approved', 'pending approval': 'To Be Approved',
  'recurring': 'Recurring', 'blocked': 'Blocked',
  'to be started': 'To Be Started', 'not started': 'To Be Started',
  'pending': 'To Be Started', 'open': 'To Be Started', 'to do': 'To Be Started',
}
function mapStatus(s) { return s ? (STATUS_MAP[s.toLowerCase().trim()] || 'To Be Started') : 'To Be Started' }

function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim())
  if (lines.length < 2) return null
  const sep = text.includes('\t') ? '\t' : ','
  const headers = lines[0].split(sep).map(h => h.trim().replace(/^"|"$/g, '').toLowerCase())
  const rows = lines.slice(1).map(line => {
    const vals = line.split(sep).map(v => v.trim().replace(/^"|"$/g, ''))
    return Object.fromEntries(headers.map((h, i) => [h, vals[i] || '']))
  }).filter(r => Object.values(r).some(v => v))
  return { headers, rows }
}

function rowToTask(row, headers, clientId) {
  const h = (keywords) => headers.find(h => keywords.some(k => h.includes(k))) || ''
  const titleField = h(['to-do', 'todo', 'task', 'title', 'name']) || headers[0]
  return {
    client_id: clientId,
    title: row[titleField] || '',
    status: mapStatus(row[h(['status'])] || ''),
    category: row[h(['category', 'type'])] || 'Other',
    duration_days: row[h(['duration', 'days'])] || '',
    remarks: row[h(['remark', 'note', 'comment'])] || '',
    eta_end: row[h(['eta', 'due', 'deadline', 'date'])] || null,
    priority: 'P2',
  }
}

// ────────── CLICKUP HELPERS ──────────
const CU_STATUS_MAP = {
  'to do': 'To Be Started', 'open': 'To Be Started', 'not started': 'To Be Started',
  'in progress': 'In Progress', 'active': 'In Progress', 'in review': 'To Be Approved',
  'review': 'To Be Approved', 'approval': 'To Be Approved',
  'complete': 'Completed', 'done': 'Completed', 'closed': 'Completed',
  'blocked': 'Blocked', 'on hold': 'Blocked',
  'recurring': 'Recurring',
}
function mapCUStatus(s) { return CU_STATUS_MAP[s?.toLowerCase()?.trim()] || 'To Be Started' }

export default function ImportPage() {
  const [clients, setClients] = useState([])
  const [members, setMembers] = useState([])
  useEffect(() => {
    apiFetch('/api/clients').then(r => r.json()).then(d => setClients(d || []))
    apiFetch('/api/team').then(r => r.json()).then(d => setMembers(d || []))
  }, [])

  return (
    <div className="p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Import</h1>
        <p className="text-gray-500 text-sm mt-1">Import tasks from CSV files or ClickUp</p>
      </div>
      <Tabs defaultValue="csv">
        <TabsList className="mb-6">
          <TabsTrigger value="csv">CSV / Google Sheets</TabsTrigger>
          <TabsTrigger value="clickup">ClickUp</TabsTrigger>
        </TabsList>
        <TabsContent value="csv">
          <CSVImport clients={clients} />
        </TabsContent>
        <TabsContent value="clickup">
          <ClickUpImport clients={clients} members={members} />
        </TabsContent>
      </Tabs>
    </div>
  )
}

// ─── CSV IMPORT ───────────────────────────────────────────────────────────────
function CSVImport({ clients }) {
  const [selectedClient, setSelectedClient] = useState('__none__')
  const [rawData, setRawData] = useState('')
  const [parsed, setParsed] = useState(null)
  const [importing, setImporting] = useState(false)
  const [result, setResult] = useState(null)
  const [pasteMode, setPasteMode] = useState(false)

  const handleFile = async (e) => {
    const file = e.target.files[0]
    if (!file) return
    const text = await file.text()
    setRawData(text)
    setParsed(parseCSV(text))
  }

  const handlePaste = () => setParsed(parseCSV(rawData))

  const handleImport = async () => {
    if (!parsed || !selectedClient || selectedClient === '__none__') return
    setImporting(true)
    const tasks = parsed.rows
      .map(row => rowToTask(row, parsed.headers, selectedClient))
      .filter(t => t.title.trim())
    let success = 0, failed = 0
    for (const task of tasks) {
      const res = await apiFetch('/api/tasks', { method: 'POST', body: JSON.stringify(task) })
      if (res.ok) success++; else failed++
    }
    setResult({ success, failed, total: tasks.length })
    setImporting(false)
    setParsed(null)
    setRawData('')
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <Card className="border border-gray-200">
        <CardHeader><CardTitle className="text-base">Upload CSV or Paste from Sheets</CardTitle></CardHeader>
        <CardContent className="space-y-4">
          {result && (
            <div className="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
              <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0" />
              <div>
                <p className="text-sm font-medium">{result.success} tasks imported</p>
                {result.failed > 0 && <p className="text-xs text-red-500">{result.failed} failed</p>}
              </div>
              <Button size="sm" variant="outline" onClick={() => setResult(null)} className="ml-auto text-xs">Import More</Button>
            </div>
          )}
          <div>
            <label className="text-sm font-medium">Target Client *</label>
            <Select value={selectedClient} onValueChange={setSelectedClient}>
              <SelectTrigger className="mt-1"><SelectValue placeholder="Select client" /></SelectTrigger>
              <SelectContent>
                <SelectItem value="__none__">Select a client…</SelectItem>
                {clients.map(c => <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>)}
              </SelectContent>
            </Select>
          </div>
          <div className="flex gap-2">
            <Button size="sm" variant={!pasteMode ? 'default' : 'outline'} onClick={() => setPasteMode(false)}>Upload CSV</Button>
            <Button size="sm" variant={pasteMode ? 'default' : 'outline'} onClick={() => setPasteMode(true)}>Paste from Sheets</Button>
          </div>
          {!pasteMode ? (
            <label className="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <Upload className="w-7 h-7 text-gray-300 mb-1" />
              <span className="text-sm text-gray-400">Click to upload .csv or .tsv</span>
              <input type="file" accept=".csv,.tsv,.txt" className="hidden" onChange={handleFile} />
            </label>
          ) : (
            <div className="space-y-2">
              <textarea value={rawData} onChange={e => setRawData(e.target.value)} placeholder="Paste tab-separated data from Google Sheets here..." className="w-full h-36 p-3 text-xs border border-gray-200 rounded-lg focus:outline-none focus:border-blue-400 font-mono resize-none" />
              <Button size="sm" onClick={handlePaste} disabled={!rawData.trim()}>Parse</Button>
            </div>
          )}
          {parsed && (
            <Button className="w-full" onClick={handleImport} disabled={importing || selectedClient === '__none__'}>
              {importing ? <><Loader2 className="w-4 h-4 mr-2 animate-spin" />Importing...</> : `Import ${parsed.rows.length} Tasks`}
            </Button>
          )}
        </CardContent>
      </Card>

      {parsed ? (
        <Card className="border border-gray-200">
          <CardHeader><CardTitle className="text-base">Preview <span className="text-xs font-normal text-gray-400">(first 10 rows)</span></CardTitle></CardHeader>
          <CardContent className="p-0">
            <div className="overflow-auto max-h-72">
              <table className="w-full text-xs">
                <thead><tr className="bg-gray-50 border-b">{parsed.headers.map(h => <th key={h} className="px-3 py-2 text-left font-semibold text-gray-600 capitalize">{h}</th>)}</tr></thead>
                <tbody className="divide-y divide-gray-50">
                  {parsed.rows.slice(0, 10).map((row, i) => (
                    <tr key={i} className="hover:bg-gray-50">
                      {parsed.headers.map(h => <td key={h} className="px-3 py-1.5 text-gray-700 max-w-[100px] truncate">{row[h]}</td>)}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      ) : (
        <Card className="border border-gray-100 bg-gray-50">
          <CardHeader><CardTitle className="text-sm text-gray-500">Supported Formats</CardTitle></CardHeader>
          <CardContent className="space-y-3 text-xs text-gray-500">
            <div><p className="font-medium text-gray-700 mb-1">Format A (Behno style):</p><code className="bg-white border border-gray-200 rounded px-2 py-1 block">To-dos, Duration, Status, ETA, Remarks</code></div>
            <div><p className="font-medium text-gray-700 mb-1">Format B (Warehouse style):</p><code className="bg-white border border-gray-200 rounded px-2 py-1 block">Category, Task, Status, Notes</code></div>
            <div><p className="font-medium text-gray-700 mb-1">Status auto-mapping:</p><ul className="space-y-0.5"><li>"Work in Progress" → <span className="text-blue-600">In Progress</span></li><li>"Implemented/Completed" → <span className="text-green-600">Completed</span></li><li>"To Be Approved" → <span className="text-amber-600">To Be Approved</span></li></ul></div>
          </CardContent>
        </Card>
      )}
    </div>
  )
}

// ─── CLICKUP IMPORT ───────────────────────────────────────────────────────────
function ClickUpImport({ clients, members }) {
  const [apiToken, setApiToken] = useState('')
  const [tokenSaved, setTokenSaved] = useState(false)
  const [workspaces, setWorkspaces] = useState([])
  const [selectedWS, setSelectedWS] = useState('__none__')
  const [spaces, setSpaces] = useState([])
  const [lists, setLists] = useState([])
  const [selectedLists, setSelectedLists] = useState([])
  const [selectedClient, setSelectedClient] = useState('__none__')
  const [loadingWS, setLoadingWS] = useState(false)
  const [loadingLists, setLoadingLists] = useState(false)
  const [importing, setImporting] = useState(false)
  const [importLog, setImportLog] = useState([])
  const [result, setResult] = useState(null)
  const [error, setError] = useState('')

  const log = (msg) => setImportLog(l => [...l, msg])

  const fetchWorkspaces = async () => {
    if (!apiToken.trim()) { setError('Please enter your ClickUp API token'); return }
    setError('')
    setLoadingWS(true)
    const res = await apiFetch('/api/clickup/workspaces', {
      method: 'POST',
      body: JSON.stringify({ token: apiToken })
    })
    const data = await res.json()
    if (!res.ok) { setError(data.error || 'Failed to fetch workspaces'); setLoadingWS(false); return }
    setWorkspaces(data.workspaces || [])
    setTokenSaved(true)
    setLoadingWS(false)
  }

  const fetchLists = async (wsId) => {
    setSelectedWS(wsId)
    setLists([])
    setSelectedLists([])
    if (wsId === '__none__') return
    setLoadingLists(true)
    const res = await apiFetch('/api/clickup/lists', {
      method: 'POST',
      body: JSON.stringify({ token: apiToken, workspace_id: wsId })
    })
    const data = await res.json()
    if (!res.ok) { setError(data.error || 'Failed to fetch lists'); setLoadingLists(false); return }
    setLists(data.lists || [])
    setLoadingLists(false)
  }

  const toggleList = (id) => setSelectedLists(s => s.includes(id) ? s.filter(x => x !== id) : [...s, id])

  const runImport = async () => {
    if (selectedLists.length === 0 || selectedClient === '__none__') return
    setImporting(true)
    setResult(null)
    setImportLog([])
    log(`Starting import of ${selectedLists.length} list(s)...`)

    const res = await apiFetch('/api/clickup/import', {
      method: 'POST',
      body: JSON.stringify({
        token: apiToken,
        list_ids: selectedLists,
        client_id: selectedClient,
        members
      })
    })
    const data = await res.json()
    if (!res.ok) {
      setError(data.error || 'Import failed')
      setImporting(false)
      return
    }
    setResult(data)
    log(`✅ Done! ${data.imported} tasks imported, ${data.skipped} skipped.`)
    setImporting(false)
  }

  return (
    <div className="space-y-6">
      {error && (
        <div className="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
          <AlertCircle className="w-4 h-4 flex-shrink-0" />{error}
        </div>
      )}

      {result && (
        <div className="flex items-center gap-3 p-4 bg-green-50 border border-green-200 rounded-lg">
          <CheckCircle className="w-5 h-5 text-green-600" />
          <div>
            <p className="font-semibold text-gray-900">Import Complete!</p>
            <p className="text-sm text-gray-600">{result.imported} tasks imported · {result.skipped} already existed</p>
          </div>
          <Button size="sm" variant="outline" onClick={() => { setResult(null); setSelectedLists([]) }} className="ml-auto">Import More</Button>
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Step 1: Token */}
        <Card className="border border-gray-200">
          <CardHeader><CardTitle className="text-base flex items-center gap-2"><Key className="w-4 h-4" /> Step 1: ClickUp API Token</CardTitle></CardHeader>
          <CardContent className="space-y-3">
            <p className="text-xs text-gray-500">Get your token: ClickUp → <b>Settings</b> → <b>Apps</b> → <b>API Token</b></p>
            <div className="flex gap-2">
              <Input
                type="password"
                value={apiToken}
                onChange={e => { setApiToken(e.target.value); setTokenSaved(false); setWorkspaces([]); setLists([]) }}
                placeholder="pk_xxxxxxxxxxxxxxxxxxxx"
                className="font-mono text-sm"
              />
              <Button onClick={fetchWorkspaces} disabled={loadingWS || !apiToken.trim()} className="flex-shrink-0">
                {loadingWS ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Connect'}
              </Button>
            </div>
            {tokenSaved && <p className="text-xs text-green-600 flex items-center gap-1"><CheckCircle className="w-3 h-3" /> Connected — {workspaces.length} workspace(s) found</p>}
          </CardContent>
        </Card>

        {/* Step 2: Workspace + Lists */}
        <Card className={`border ${!tokenSaved ? 'border-gray-100 opacity-60' : 'border-gray-200'}`}>
          <CardHeader><CardTitle className="text-base">Step 2: Select Workspace &amp; Lists</CardTitle></CardHeader>
          <CardContent className="space-y-3">
            <Select value={selectedWS} onValueChange={fetchLists} disabled={!tokenSaved}>
              <SelectTrigger><SelectValue placeholder="Choose workspace" /></SelectTrigger>
              <SelectContent>
                <SelectItem value="__none__">Choose workspace…</SelectItem>
                {workspaces.map(w => <SelectItem key={w.id} value={w.id}>{w.name}</SelectItem>)}
              </SelectContent>
            </Select>

            {loadingLists && <div className="flex items-center gap-2 text-xs text-gray-400"><Loader2 className="w-3 h-3 animate-spin" /> Fetching lists...</div>}

            {lists.length > 0 && (
              <div>
                <p className="text-xs font-medium text-gray-600 mb-2">Select lists to import ({selectedLists.length} selected):</p>
                <div className="space-y-1 max-h-48 overflow-y-auto">
                  {lists.map(l => (
                    <label key={l.id} className="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-50 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={selectedLists.includes(l.id)}
                        onChange={() => toggleList(l.id)}
                        className="rounded"
                      />
                      <span className="text-sm text-gray-700">{l.name}</span>
                      <span className="text-xs text-gray-400 ml-auto">{l.space_name}</span>
                    </label>
                  ))}
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Step 3: Target Client */}
        <Card className={`border ${selectedLists.length === 0 ? 'border-gray-100 opacity-60' : 'border-gray-200'}`}>
          <CardHeader><CardTitle className="text-base">Step 3: Map to Client</CardTitle></CardHeader>
          <CardContent>
            <p className="text-xs text-gray-500 mb-3">Which client should these tasks be imported into?</p>
            <Select value={selectedClient} onValueChange={setSelectedClient} disabled={selectedLists.length === 0}>
              <SelectTrigger><SelectValue placeholder="Select client" /></SelectTrigger>
              <SelectContent>
                <SelectItem value="__none__">Select client…</SelectItem>
                {clients.map(c => <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>)}
              </SelectContent>
            </Select>
          </CardContent>
        </Card>

        {/* Step 4: Import */}
        <Card className={`border ${(selectedLists.length === 0 || selectedClient === '__none__') ? 'border-gray-100 opacity-60' : 'border-blue-200 bg-blue-50'}`}>
          <CardHeader><CardTitle className="text-base">Step 4: Run Import</CardTitle></CardHeader>
          <CardContent className="space-y-3">
            <p className="text-xs text-gray-500">{selectedLists.length} list(s) → {clients.find(c => c.id === selectedClient)?.name || '—'}</p>
            <Button
              className="w-full"
              onClick={runImport}
              disabled={importing || selectedLists.length === 0 || selectedClient === '__none__'}
            >
              {importing ? <><Loader2 className="w-4 h-4 mr-2 animate-spin" />Importing from ClickUp...</> : 'Start Import'}
            </Button>
            {importLog.length > 0 && (
              <div className="bg-gray-900 rounded p-3 text-xs text-green-400 font-mono space-y-1 max-h-24 overflow-y-auto">
                {importLog.map((l, i) => <div key={i}>{l}</div>)}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
